// Generated by CoffeeScript 1.10.0

/*
Dogear (c)2012-2014 Matthew Oertle
 */

(function() {
  var $, cancelEvent;

  $ = Dogear.$;

  Dogear.App = (function() {
    function App(base_url) {
      this.base_url = base_url;
      if (Dogear.app != null) {
        return;
      }
      Dogear.app = this;
      this.$shade = $('<div id="share_shade"></div>').appendTo($(document.body));
      this.$app = $('<div id="share_app"> <div id="share_titlebar"> <img id="share_close" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAADEUlEQVR42mVSaU9TQRSdCsZgQIgGsaSgbeG5hIKscalrYqIRA6FUTVwSYvyiiOygFDdwi8a/IipuifpJPgkobqh0oaWPLq8LlFdabc3xvkkgAT+c5EzuuWfO3LkMwBL4BEEX0OstPp3uzXR+ftCt0QSncnPfTq5f32vLzi5crl9yCAhCY9hQJAeqjySlc2chWToh9XTA13Aa4qGDf+3qDdGJtWtbqU31n4FHq30ZqCiXpfMNkI6b4Nu3B15DETwE714jfOY6MjoDh1Ao/8jIeMdNFgxEjabRU2KQ/adOwltVgUBdHeQXzxGfcing3F9fj+my7fCeNOPXxjz5a1paCzdw5uToXBpN1F9TDam8DLP37uJ3LIZE4g+SyYQCzn/H4wg/fABPsQHi0cP4unp19MuqVXpmz862TJcUJ6QD+xE0mRCfn8e9+3fQf7sPkUgEMzMz6LFcwcNHDxAnY7/ZDO8eIyaEgsTH1NR+Zl237s30jip4S7cjMvgM8XgMHV3tMJ8woa29GS1tlzm/2Xed1yKvX8FNc3GQngzes5+ZmUGPMjBBgOywIxabh8/nw6Wmi0ojR3NrEyRJ4jVZdMOt1cJl3IURlSrCvqenB0XjbogFBZizWxGNymTgxeWWS4sGrZRCkvy8Nud2wbVpE5yUmht8S0t766RI4ratCA08xtxcBL3XenhjU3MjJbnAeU/vVV4LvRiEUyiEdesWjKpUQ+xTamrvRF5e0l1RBrGmBrMzIdy4dR2d3e0QKe4UfeNVSzfu3O3D7GwYoqkOrtISjKvVyRHGbrOPjBWOrlwZdVZVwlWgh6fvFsKhAMLhEP0AB3EFQXjoiyd1WjgqKzCSkiJ/YGwzX6RRxlrHMtfIzt074dDr4DpWDf+TxwjarRz+pwNw1tbCpqW379oBRTvMWNfiJiprSQN59zkrS7aTwFFeCjulsanVsBJsxB20hTYa3Bhp6O3vqWfFgsGiCUVqGU5JiY5vzE/8KjHAvs/IofDx/LwkxeY3LzQvGCwBCfQ0nP5huoV4RAGlG1IGprx5uf4fTJJ9aEdY7DYAAAAASUVORK5CYII=" width="16" height="16" /> <span>Dogear</span> </div> <div id="share_body"> <span class="share_subtle">Loading...</span> </div> </div>').appendTo($(document.body));
      this.$body = this.$app.find('DIV#share_body');
      $(document).on('keydown.research', function(event) {
        if (27 === event.keyCode) {
          Dogear.app.close();
          return cancelEvent(event);
        }
        if (13 === event.keyCode) {
          Dogear.app.share();
          return cancelEvent(event);
        }
      });
      this.$app.on('mousedown.research', function(event) {
        if (event.shiftKey) {
          return;
        }
        Dogear.app.drag = Dogear.app.$app.offset();
        Dogear.app.drag.x = event.screenX;
        Dogear.app.drag.y = event.screenY;
        return cancelEvent(event);
      });
      $(document).on('mousemove.research', function(event) {
        var x, y;
        if (!Dogear.app.drag) {
          return;
        }
        x = Dogear.app.drag.left + event.screenX - Dogear.app.drag.x;
        y = Dogear.app.drag.top + event.screenY - Dogear.app.drag.y;
        Dogear.app.$app.offset({
          top: y,
          left: x
        });
        return cancelEvent(event);
      });
      $(document).on('mouseup.research', function(event) {
        Dogear.app.drag = null;
      });
      $('IMG#share_close').on('click.research', function(event) {
        Dogear.app.close();
        return cancelEvent(event);
      });
      $.ajax({
        url: this.base_url + "/share/caps",
        type: 'GET',
        dataType: 'jsonp'
      }).done((function(_this) {
        return function(msg) {
          return _this.$body.fadeOut('fast', function() {
            if (msg.user) {
              _this.$body.empty().append($('<input id="share_title" /> <textarea id="share_msg" autofocus="autofocus" class="share_note" placeholder="Describe the page..."></textarea>'));
              _this.$title = $('#share_title').val(document.title || '<no title>');
              _this.$msg = $('#share_msg');
              _this.$title.on('mousedown.research', function(event) {
                event.stopPropagation();
              });
              _this.$msg.on('mousedown.research', function(event) {
                event.stopPropagation();
              });
              $('#share_share').on('mousedown.research', function(event) {
                event.stopPropagation();
              }).on('click.research', function(event) {
                Dogear.app.share();
              });
            } else {
              _this.$body.html("<a href=\"" + _this.base_url + "\" target=\"_blank\">Sign in.</a>");
              _this.$app.find('A').on('click', function() {
                return _this.close();
              });
            }
            _this.$body.fadeIn('fast');
          });
        };
      })(this));
      return this;
    }

    App.prototype.share = function() {
      $.ajax({
        url: this.base_url + "/share/post",
        type: 'GET',
        dataType: 'jsonp',
        data: {
          title: Dogear.app.$title.val(),
          msg: Dogear.app.$msg.val()
        }
      }).done((function(_this) {
        return function(msg) {
          return _this.close();
        };
      })(this)).fail((function(_this) {
        return function(jqXHR, textStatus, errorThrown) {
          return alert('Failed');
        };
      })(this));
    };

    App.prototype.close = function() {
      Dogear.app.$shade.fadeOut('fast', (function(_this) {
        return function() {
          Dogear.app.$shade.remove();
        };
      })(this));
      Dogear.app.$app.fadeOut('fast', (function(_this) {
        return function() {
          Dogear.app.$app.remove();
          delete window.Dogear.app;
        };
      })(this));
      $(document).off('.research');
    };

    return App;

  })();

  cancelEvent = function(event) {
    event.preventDefault();
    event.stopPropagation();
    return false;
  };

}).call(this);

//# sourceMappingURL=dogear.js.map
